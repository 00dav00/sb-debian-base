---
- include: deploy-username-tasks.yml
  when: deploy_username is defined

- name: Disallow SSH password authentication
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^PasswordAuthentication"
    line="PasswordAuthentication no"
    state=present

- name: Disallow root SSH access
  lineinfile:
   dest=/etc/ssh/sshd_config
   regexp="^PermitRootLogin"
   line="PermitRootLogin no"
   state=present
  notify:
    - restart sshd
  when: ansible_distribution == "Debian"

- name: Disallow root SSH access for Ubuntu versions later 14.04
  lineinfile:
   dest=/etc/ssh/sshd_config
   regexp="^PermitRootLogin"
   line="PermitRootLogin no"
   state=present
  notify:
    - restart ssh
  when: ansible_distribution_release == "{{ item }}"
  with_items:
    - precise
    - trusty

- name: Dist upgrade packges
  apt: upgrade=dist

- name: Install packges
  apt: name={{ item }} state=present
  with_items:
    - vim
    - tmux
    - htop
    - atop
    - ufw
    - emacs24-nox
    - atsar
    - git
    - curl
    - libgmp-dev

- name: Set hostname to host-specific variable
  hostname: name={{ hostname }}
  when: hostname is defined
  tags:
    - set-hostname

- name: Version 8.5 of debian introduce a bug, this is a work around
  lineinfile:
    dest=/etc/default/ufw regexp=^IPV6=yes line=IPV6=no
  when: ansible_distribution == "Debian"

- name: Enable ufw
  ufw: state=enabled policy=deny

- name: Open general ports
  ufw: rule=allow port={{ item }}  proto=tcp
  with_items:
    - "{{ ports | default([22]) }}"

- name: Open ports by IP
  ufw: rule=allow port={{ item.value.port }}  proto=tcp src={{ item.value.ip }}
  with_dict: "{{ port_ips | default({}) }}"
