---
- name: Make sure that the authorized_keys file is set up for the admin user
  authorized_key:
    user: "{{ admin_user }}"
    key:  "{{ item }}"
  with_file:
    - keys/administrators

- name: Disallow SSH password authentication
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^PasswordAuthentication"
    line: "PasswordAuthentication no"
    state: present

- name: Disallow root SSH access
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^PermitRootLogin"
    line: "PermitRootLogin no"
    state: present
  notify:
    - restart ssh

- name: Set hostname to host-specific variable
  hostname:
    name: "{{ hostname }}"
  when: hostname is defined
  tags:
    - set-hostname

- name: Set time zone
  command: timedatectl set-timezone "{{ ntp_timezone }}"

- name: Enable NTP
  command: timedatectl set-ntp true

- name: Update package cache and upgrade packages
  apt:
    upgrade: dist
    update_cache: yes

- name: Install extra packages
  apt:
    name: "{{ item }}"
    state: latest
  with_items: "{{ sb_debian_base_extra_packages }}"

- include: firewall.yml

- include: deploy-username-tasks.yml
  when: deploy_username is defined
