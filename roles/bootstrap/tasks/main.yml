- name: Disallow SSH password authentication
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^PasswordAuthentication"
    line="PasswordAuthentication no"
    state=present
  tags:
    - bootstrap

- name: Disallow root SSH access
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  lineinfile:
   dest=/etc/ssh/sshd_config
   regexp="^PermitRootLogin"
   line="PermitRootLogin no"
   state=present
  notify:
    - restart sshd
  tags:
    - bootstrap

- name: Dist upgrade packges
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  apt: upgrade=dist
  tags:
    - bootstrap

- name: Install packges
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  apt: name={{ item }} state=present
  with_items:
    - vim
    - tmux
    - htop
    - atop
    - ufw
    - emacs24-nox
    - atsar
    - git
    - curl
  tags:
    - bootstrap

- name: Create stackbuilders group
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  group: name=stackbuilders state=present
  tags:
    - bootstrap

- name: Add stackbuilders user
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  user: name=stackbuilders comment="Unprivileged Stack Builders User" groups=stackbuilders,sudo shell=/bin/bash generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa
  tags:
    - bootstrap

- name: Set up authorized_keys for the stackbuilders user
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  authorized_key: user=stackbuilders
                  key="{{ item }}"
  with_file:
    - keys/stackbuilders
    - keys/ci-{{ app_environment }}
  tags:
    - bootstrap

- name: Ensure github.com is a known host
  remote_user: stackbuilders
  become: yes
  become_method: sudo
  lineinfile:
    dest: /home/stackbuilders/.ssh/known_hosts
    create: yes
    state: present
    line: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
    regexp: "^github\\.com"
    group: users
    owner: stackbuilders
  tags:
    - bootstrap

- name: Set hostname to host-specific variable
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  hostname: name={{ hostname }}
  when: hostname is defined
  tags:
    - bootstrap
    - set-hostname

- name: Set hostname to host name in inventory
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  hostname: name={{ inventory_hostname }}
  when: hostname is undefined
  tags:
    - bootstrap
    - set-hostname

- name: Enable ufw
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  ufw: state=enabled policy=deny
  tags:
    - bootstrap

- name: Open ports
  remote_user: "{{ os_username }}"
  become: yes
  become_method: sudo
  ufw: rule=allow port={{ item }}  proto=tcp
  with_items:
    - "{{ ports }}"
  tags:
    - bootstrap
